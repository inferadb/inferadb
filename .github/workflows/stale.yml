name: Close stale issues and PRs

on:
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  issues: write
  pull-requests: write

jobs:
  stale:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Mark stale issues awaiting user response
        uses: actions/stale@5bef64f19d7facfb25b37b414482c7164d639639 # v9.1.0
        with:
          # Only process issues where USER owes action (not maintainer)
          only-issue-labels: "status/needs-info"
          stale-issue-message: >
            This issue has been marked as stale because we haven't received the
            requested information. It will be closed in 14 days if no response is provided.
            Please provide the requested details to keep this issue open.
          close-issue-message: >
            This issue was closed due to inactivity after requesting more information.
            Feel free to reopen with the requested details if this is still relevant.
          stale-issue-label: "stale"
          days-before-issue-stale: 14
          days-before-issue-close: 14

          # PRs with requested changes
          only-pr-labels: "status/needs-info"
          stale-pr-message: >
            This PR has been marked as stale because we haven't received a response
            to the requested changes. It will be closed in 14 days if no updates are made.
          close-pr-message: >
            This PR was closed due to inactivity after requesting changes.
            Feel free to reopen when ready to address the feedback.
          stale-pr-label: "stale"
          days-before-pr-stale: 14
          days-before-pr-close: 14

          # General configuration
          operations-per-run: 100
          remove-stale-when-updated: true
          delete-branch: false

      - name: Mark stale PRs with no activity
        uses: actions/stale@5bef64f19d7facfb25b37b414482c7164d639639 # v9.1.0
        with:
          # Don't process issues in this step (handled above with stricter rules)
          days-before-issue-stale: -1
          days-before-issue-close: -1

          # PRs without activity (more lenient than issues)
          stale-pr-message: >
            This PR has been marked as stale due to 60 days of inactivity.
            It will be closed in 14 days if no activity occurs.
            If this PR is still relevant, please push updates or comment.
          close-pr-message: >
            This PR was closed due to extended inactivity.
            Feel free to reopen when ready to continue.
          stale-pr-label: "stale"
          exempt-pr-labels: "priority/critical,priority/high,status/blocked,status/in-progress,status/ready-for-review"
          days-before-pr-stale: 60
          days-before-pr-close: 14

          operations-per-run: 100
          remove-stale-when-updated: true
          delete-branch: false
