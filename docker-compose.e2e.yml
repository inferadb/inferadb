# InferaDB End-to-End Test Environment
#
# This setup provides a complete stack for E2E testing:
# - Single-node Ledger cluster
# - Engine with Ledger storage backend
# - Control with Ledger storage backend
#
# NOT FOR PRODUCTION USE
#
# Usage:
#   docker-compose -f docker-compose.e2e.yml up -d
#   cargo test --test integration -- --test-threads=1
#   docker-compose -f docker-compose.e2e.yml down
#
# Or with the helper script:
#   ./tests/run-e2e.sh

services:
  # ==========================================================================
  # Ledger - Storage Backend
  # ==========================================================================
  ledger:
    build:
      context: ./ledger
      dockerfile: Dockerfile
    container_name: inferadb-e2e-ledger
    hostname: ledger
    networks:
      - e2e-network
    ports:
      - "50051:50051"
      - "9093:9090"
    environment:
      # Single-node bootstrap (no Raft cluster)
      INFERADB__LEDGER__BOOTSTRAP_EXPECT: "1"
      INFERADB__LEDGER__LISTEN_ADDR: "0.0.0.0:50051"
      INFERADB__LEDGER__METRICS_ADDR: "0.0.0.0:9090"
      INFERADB__LEDGER__DATA_DIR: "/var/lib/ledger"
      RUST_LOG: "info,inferadb_ledger_server=debug"
    volumes:
      - ledger-data:/var/lib/ledger
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50051 || exit 1"]
      interval: 2s
      timeout: 5s
      retries: 30
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # ==========================================================================
  # Control - Management Plane
  # ==========================================================================
  control:
    build:
      context: ./control
      dockerfile: Dockerfile
    container_name: inferadb-e2e-control
    hostname: control
    networks:
      - e2e-network
    ports:
      - "9090:9090"  # HTTP API
      - "9091:9091"  # gRPC
      - "9092:9092"  # Mesh
    depends_on:
      ledger:
        condition: service_healthy
    environment:
      # Control configuration
      INFERADB__CONTROL__LISTEN__HTTP: "0.0.0.0:9090"
      INFERADB__CONTROL__LISTEN__GRPC: "0.0.0.0:9091"
      INFERADB__CONTROL__LISTEN__MESH: "0.0.0.0:9092"
      INFERADB__CONTROL__FRONTEND__URL: "http://localhost:9090"
      # Storage: Use Ledger
      INFERADB__CONTROL__STORAGE: "ledger"
      INFERADB__CONTROL__LEDGER__ENDPOINT: "http://ledger:50051"
      INFERADB__CONTROL__LEDGER__CLIENT_ID: "control-e2e"
      INFERADB__CONTROL__LEDGER__NAMESPACE_ID: "1"
      # WebAuthn (localhost for testing)
      INFERADB__CONTROL__WEBAUTHN__PARTY: "localhost"
      INFERADB__CONTROL__WEBAUTHN__ORIGIN: "http://localhost:9090"
      # Email (disabled for E2E tests)
      INFERADB__CONTROL__EMAIL__HOST: "localhost"
      INFERADB__CONTROL__EMAIL__PORT: "1025"
      INFERADB__CONTROL__EMAIL__ADDRESS: "noreply@inferadb.test"
      INFERADB__CONTROL__EMAIL__NAME: "InferaDB E2E"
      # Engine mesh connectivity
      INFERADB__CONTROL__MESH__URL: "http://engine"
      INFERADB__CONTROL__MESH__GRPC: "8081"
      INFERADB__CONTROL__MESH__PORT: "8082"
      # Logging
      RUST_LOG: "info,inferadb_control=debug"
      RUST_BACKTRACE: "1"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/healthz"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 30s

  # ==========================================================================
  # Engine - Authorization Engine
  # ==========================================================================
  engine:
    build:
      context: ./engine
      dockerfile: Dockerfile
    container_name: inferadb-e2e-engine
    hostname: engine
    networks:
      - e2e-network
    ports:
      - "8080:8080"  # HTTP API
      - "8081:8081"  # gRPC
      - "8082:8082"  # Mesh
    depends_on:
      ledger:
        condition: service_healthy
      control:
        condition: service_healthy
    environment:
      # Engine configuration
      INFERADB__ENGINE__LISTEN__HTTP: "0.0.0.0:8080"
      INFERADB__ENGINE__LISTEN__GRPC: "0.0.0.0:8081"
      INFERADB__ENGINE__LISTEN__MESH: "0.0.0.0:8082"
      # Storage: Use Ledger
      INFERADB__ENGINE__STORAGE: "ledger"
      INFERADB__ENGINE__LEDGER__ENDPOINT: "http://ledger:50051"
      INFERADB__ENGINE__LEDGER__CLIENT_ID: "engine-e2e"
      INFERADB__ENGINE__LEDGER__NAMESPACE_ID: "1"
      # Cache configuration
      INFERADB__ENGINE__CACHE__ENABLED: "true"
      INFERADB__ENGINE__CACHE__CAPACITY: "10000"
      INFERADB__ENGINE__CACHE__TTL: "300"
      # Token validation
      INFERADB__ENGINE__TOKEN__CACHE_TTL: "300"
      INFERADB__ENGINE__TOKEN__CLOCK_SKEW: "60"
      INFERADB__ENGINE__TOKEN__MAX_AGE: "86400"
      # Control mesh connectivity (for JWKS fetching)
      INFERADB__ENGINE__MESH__URL: "http://control:9092"
      INFERADB__ENGINE__MESH__TIMEOUT: "5000"
      INFERADB__ENGINE__MESH__CACHE_TTL: "300"
      INFERADB__ENGINE__MESH__CERT_CACHE_TTL: "900"
      # Logging
      RUST_LOG: "info,inferadb_engine=debug,inferadb_engine_api=debug"
      RUST_BACKTRACE: "1"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 30s

  # ==========================================================================
  # MailHog - Email Testing (optional)
  # ==========================================================================
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: inferadb-e2e-mailhog
    networks:
      - e2e-network
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    profiles:
      - email

networks:
  e2e-network:
    driver: bridge
    name: inferadb-e2e-network

volumes:
  ledger-data:
    name: inferadb-e2e-ledger-data
